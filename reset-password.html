<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Reset Password | Smart Road Damage Response</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap");

      :root {
        --bg-top: #f5f8ff;
        --bg-bottom: #e9f0ff;
        --panel: #ffffff;
        --ink: #172033;
        --muted: #5f6b80;
        --accent: #e4572e;
        --accent-2: #2f80ed;
        --border: #dce4f2;
        --focus: #ffb703;
        --danger: #b42318;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Outfit", "Segoe UI", sans-serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 15% 10%, rgba(228, 87, 46, 0.2), transparent 42%),
          radial-gradient(circle at 88% 20%, rgba(47, 128, 237, 0.24), transparent 45%),
          linear-gradient(180deg, var(--bg-top) 0%, var(--bg-bottom) 100%);
        display: grid;
        place-items: center;
        padding: 24px;
      }

      .card {
        width: min(440px, 100%);
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 20px 40px rgba(16, 24, 40, 0.12);
      }

      h1 {
        margin: 0;
        font-size: 1.6rem;
      }

      .subtitle {
        margin: 8px 0 18px;
        color: var(--muted);
      }

      form {
        display: grid;
        gap: 12px;
      }

      label {
        font-size: 0.9rem;
        color: var(--muted);
      }

      input,
      button {
        font: inherit;
      }

      input {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 12px;
        background: #fff;
      }

      input:focus,
      button:focus {
        outline: 2px solid var(--focus);
        outline-offset: 2px;
      }

      .hint {
        margin: -4px 0 2px;
        font-size: 0.8rem;
        color: var(--muted);
      }

      .btn {
        margin-top: 6px;
        border: 0;
        border-radius: 999px;
        color: #fff;
        padding: 11px 16px;
        cursor: pointer;
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
      }

      .status {
        margin-top: 10px;
        min-height: 1.2rem;
        font-size: 0.9rem;
      }

      .status.error {
        color: var(--danger);
      }

      .status.success {
        color: #067647;
      }

      .link {
        margin-top: 10px;
        font-size: 0.9rem;
      }

      .link a {
        color: var(--ink);
        text-decoration: none;
      }
    </style>
  </head>
  <body>
    <main class="card">
      <h1>Reset Password</h1>
      <p class="subtitle">Enter a new password for your account.</p>

      <form id="reset-form" novalidate>
        <div>
          <label for="new-password">New Password</label>
          <input id="new-password" type="password" required />
          <p class="hint">Minimum 8 characters, at least one uppercase letter and one number.</p>
        </div>

        <div>
          <label for="confirm-password">Confirm Password</label>
          <input id="confirm-password" type="password" required />
        </div>

        <button type="submit" class="btn">Update Password</button>
      </form>

      <div id="status" class="status" aria-live="polite"></div>
      <div class="link"><a href="login.html">Back to Login</a></div>
    </main>

    <script>
      function unique(values) {
        return Array.from(new Set(values));
      }

      function buildApiBaseCandidates() {
        const localhostApi = "http://localhost:3000";

        if (window.location.protocol === "file:") {
          return [localhostApi];
        }

        const sameOrigin = window.location.origin;
        const isLocalHost = ["localhost", "127.0.0.1"].includes(window.location.hostname);

        if (isLocalHost) {
          return unique([localhostApi, sameOrigin]);
        }

        return unique([sameOrigin, localhostApi]);
      }

      const API_BASE_CANDIDATES = buildApiBaseCandidates();

      async function apiRequest(path, options) {
        let lastError = "Unable to reach API";

        for (const base of API_BASE_CANDIDATES) {
          try {
            const response = await fetch(`${base}${path}`, options);

            let payload = {};
            const contentType = response.headers.get("content-type") || "";

            if (contentType.includes("application/json")) {
              payload = await response.json();
            } else {
              const text = await response.text();
              payload = { error: text || `Request failed (${response.status})` };
            }

            if (!response.ok) {
              const errorMessage = payload.error || payload.message || `Request failed (${response.status})`;
              if (response.status === 404 && base !== API_BASE_CANDIDATES[API_BASE_CANDIDATES.length - 1]) {
                lastError = errorMessage;
                continue;
              }
              return { ok: false, error: errorMessage };
            }

            return { ok: true, payload };
          } catch (error) {
            lastError = error && error.message ? error.message : "Network error";
          }
        }

        return {
          ok: false,
          error: "Cannot connect to backend. Start server with: cd server; npm.cmd start",
          details: lastError,
        };
      }

      function setStatus(message, type) {
        const status = document.getElementById("status");
        status.textContent = message;
        status.className = `status ${type}`;
      }

      function isPasswordValid(password) {
        return password.length >= 8 && /[A-Z]/.test(password) && /[0-9]/.test(password);
      }

      const token = new URLSearchParams(window.location.search).get("token") || "";
      if (!token) {
        setStatus("Reset token is missing. Open the reset link from your email.", "error");
      }

      document.getElementById("reset-form").addEventListener("submit", async (event) => {
        event.preventDefault();
        setStatus("", "");

        if (!token) {
          setStatus("Reset token is missing. Open the reset link from your email.", "error");
          return;
        }

        const password = document.getElementById("new-password").value;
        const confirmPassword = document.getElementById("confirm-password").value;

        if (!password || !confirmPassword) {
          setStatus("Please enter and confirm your new password.", "error");
          return;
        }

        if (!isPasswordValid(password)) {
          setStatus("Password must be 8+ characters with one uppercase letter and one number.", "error");
          return;
        }

        if (password !== confirmPassword) {
          setStatus("Passwords do not match.", "error");
          return;
        }

        const result = await apiRequest("/api/auth/reset", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ token, password }),
        });

        if (!result.ok) {
          setStatus(result.error, "error");
          return;
        }

        setStatus(result.payload.message || "Password updated successfully.", "success");
        setTimeout(() => {
          window.location.href = "login.html";
        }, 1200);
      });
    </script>
  </body>
</html>
