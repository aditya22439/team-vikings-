<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Login | Smart Road Damage Response</title>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700&display=swap");

      :root {
        --bg-top: #f5f8ff;
        --bg-bottom: #e9f0ff;
        --panel: #ffffff;
        --ink: #172033;
        --muted: #5f6b80;
        --accent: #e4572e;
        --accent-2: #2f80ed;
        --border: #dce4f2;
        --focus: #ffb703;
        --danger: #b42318;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "Outfit", "Segoe UI", sans-serif;
        color: var(--ink);
        background:
          radial-gradient(circle at 15% 10%, rgba(228, 87, 46, 0.2), transparent 42%),
          radial-gradient(circle at 88% 20%, rgba(47, 128, 237, 0.24), transparent 45%),
          linear-gradient(180deg, var(--bg-top) 0%, var(--bg-bottom) 100%);
        display: grid;
        place-items: center;
        padding: 24px;
      }

      .login-card {
        width: min(440px, 100%);
        background: var(--panel);
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 24px;
        box-shadow: 0 20px 40px rgba(16, 24, 40, 0.12);
      }

      h1 {
        margin: 0;
        font-size: 1.6rem;
      }

      .subtitle {
        margin: 8px 0 18px;
        color: var(--muted);
        line-height: 1.5;
      }

      form {
        display: grid;
        gap: 12px;
      }

      label {
        font-size: 0.9rem;
        color: var(--muted);
      }

      input,
      select,
      button {
        font: inherit;
      }

      input,
      select {
        width: 100%;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 10px 12px;
        background: #fff;
      }

      input:focus,
      select:focus,
      button:focus {
        outline: 2px solid var(--focus);
        outline-offset: 2px;
      }

      .role-note,
      .hint {
        margin: -4px 0 2px;
        font-size: 0.8rem;
        color: var(--muted);
      }

      .btn {
        margin-top: 6px;
        border: 0;
        border-radius: 999px;
        color: #fff;
        padding: 11px 16px;
        cursor: pointer;
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
      }

      .status {
        margin-top: 10px;
        min-height: 1.2rem;
        font-size: 0.9rem;
      }

      .status.error {
        color: var(--danger);
      }

      .status.success {
        color: #067647;
      }

      .divider {
        margin: 14px 0;
        height: 1px;
        background: var(--border);
      }
    </style>
  </head>
  <body>
    <main class="login-card">
      <h1>User Login</h1>
      <p class="subtitle">Access is available for Developer, Municipality, and User accounts.</p>

      <form id="login-form" novalidate>
        <div>
          <label for="user-id" id="login-id-label">User ID / Username</label>
          <input id="user-id" type="text" placeholder="Enter user ID or username" required />
          <p class="hint" id="login-id-note">For User and Municipality, enter Email or Phone.</p>
        </div>

        <div>
          <label for="password">Password</label>
          <input id="password" type="password" placeholder="Enter password" required />
        </div>

        <div>
          <label for="role">Role</label>
          <select id="role" required>
            <option value="Developer">Developer</option>
            <option value="Municipality">Municipality</option>
            <option value="User">User</option>
          </select>
          <p class="role-note">Select the same role used during account creation.</p>
        </div>

        <button type="submit" class="btn">Login</button>
      </form>

      <div id="login-status" class="status" aria-live="polite"></div>

      <div class="divider"></div>

      <p class="hint" style="margin: 0 0 12px;">New user? <a href="signin.html">Create New Account</a></p>

      <form id="forgot-form" novalidate>
        <div>
          <label for="forgot-email">Forgot Password</label>
          <input id="forgot-email" type="email" placeholder="Enter registered email" required />
          <p class="hint">We will send password recovery instructions to your email.</p>
        </div>

        <button type="submit" class="btn">Send Reset Link</button>
      </form>

      <div id="forgot-status" class="status" aria-live="polite"></div>
    </main>

    <script>
      const CURRENT_USER_KEY = "srdr_current_user_v1";
      const CURRENT_TOKEN_KEY = "srdr_auth_token_v1";
      const ALLOWED_ROLES = ["Developer", "Municipality", "User"];

      function unique(values) {
        return Array.from(new Set(values));
      }

      function buildApiBaseCandidates() {
        const localhostApi = "http://localhost:3000";

        if (window.location.protocol === "file:") {
          return [localhostApi];
        }

        const sameOrigin = window.location.origin;
        const isLocalHost = ["localhost", "127.0.0.1"].includes(window.location.hostname);

        if (isLocalHost) {
          return unique([localhostApi, sameOrigin]);
        }

        return unique([sameOrigin, localhostApi]);
      }

      const API_BASE_CANDIDATES = buildApiBaseCandidates();

      async function apiRequest(path, options) {
        let lastError = "Unable to reach API";

        for (const base of API_BASE_CANDIDATES) {
          try {
            const response = await fetch(`${base}${path}`, options);

            let payload = {};
            const contentType = response.headers.get("content-type") || "";

            if (contentType.includes("application/json")) {
              payload = await response.json();
            } else {
              const text = await response.text();
              payload = { error: text || `Request failed (${response.status})` };
            }

            if (!response.ok) {
              const errorMessage = payload.error || payload.message || `Request failed (${response.status})`;

              // Try another base when this origin does not host the backend routes.
              if (response.status === 404 && base !== API_BASE_CANDIDATES[API_BASE_CANDIDATES.length - 1]) {
                lastError = errorMessage;
                continue;
              }

              return { ok: false, error: errorMessage };
            }

            return { ok: true, payload };
          } catch (error) {
            lastError = error && error.message ? error.message : "Network error";
          }
        }

        return {
          ok: false,
          error:
            "Cannot connect to backend. Start server with: cd server; npm.cmd start",
          details: lastError,
        };
      }

      function setStatus(id, message, type) {
        const status = document.getElementById(id);
        status.textContent = message;
        status.className = `status ${type}`;
      }

      function isAllowedRole(role) {
        return ALLOWED_ROLES.includes(role);
      }

      function syncLoginFieldForRole() {
        const role = document.getElementById("role").value;
        const label = document.getElementById("login-id-label");
        const input = document.getElementById("user-id");
        const note = document.getElementById("login-id-note");

        if (role === "Developer") {
          label.textContent = "User ID";
          input.placeholder = "Enter developer user ID";
          note.textContent = "Developer login uses User ID.";
          return;
        }

        label.textContent = "Email or Phone";
        input.placeholder = `Enter ${role.toLowerCase()} email or phone`;
        note.textContent = "Use either email or phone number (not both).";
      }

      function getLandingPageForRole(role) {
        if (role === "User") return "user-dashboard.html";
        if (role === "Municipality") return "municipality-dashboard.html";
        return "index.html";
      }

      syncLoginFieldForRole();
      document.getElementById("role").addEventListener("change", syncLoginFieldForRole);

      document.getElementById("login-form").addEventListener("submit", async (event) => {
        event.preventDefault();
        setStatus("login-status", "", "");

        const rawLoginId = document.getElementById("user-id").value.trim();
        const password = document.getElementById("password").value;
        const role = document.getElementById("role").value;

        if (!rawLoginId || !password || !role) {
          setStatus("login-status", "Please enter login ID, password, and role.", "error");
          return;
        }

        if (!isAllowedRole(role)) {
          setStatus("login-status", "Role must be Developer, Municipality, or User.", "error");
          return;
        }

        const loginPayload = { password, role };
        if (role === "Developer") {
          loginPayload.userId = rawLoginId.toUpperCase();
        } else {
          loginPayload.loginId = rawLoginId;
        }

        const result = await apiRequest("/api/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(loginPayload),
        });

        if (!result.ok) {
          setStatus("login-status", result.error, "error");
          return;
        }

        const payload = result.payload;

        localStorage.setItem(CURRENT_TOKEN_KEY, payload.token);
        localStorage.setItem(CURRENT_USER_KEY, JSON.stringify(payload.user));

        setStatus("login-status", `Login successful. Welcome ${payload.user.name}.`, "success");
        window.location.href = getLandingPageForRole(payload.user.role);
      });

      document.getElementById("forgot-form").addEventListener("submit", async (event) => {
        event.preventDefault();
        setStatus("forgot-status", "", "");

        const email = document.getElementById("forgot-email").value.trim().toLowerCase();

        if (!email) {
          setStatus("forgot-status", "Please enter your registered email.", "error");
          return;
        }

        const result = await apiRequest("/api/auth/forgot", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email }),
        });

        if (!result.ok) {
          setStatus("forgot-status", result.error, "error");
          return;
        }

        const payload = result.payload;
        setStatus(
          "forgot-status",
          payload.message || "If your account exists, reset instructions will be sent.",
          "success",
        );
      });
    </script>
  </body>
</html>



